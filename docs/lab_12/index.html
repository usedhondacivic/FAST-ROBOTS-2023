<!DOCTYPE html>
<html lang="en">

<head>
    <title>Lab 12 - Path Planning and Execution | Michael Crum's Portfolio</title>

    <!-- seo -->
    <meta name="author" content="Michael Crum">
    <meta name="description" content="Page for lab 12">
    <meta name="keywords" content="portfolio,developer,robotics,personal">

    <!-- display -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- icon -->
    <link rel="icon" type="image/png" sizes="32x32" href="../global_assets/icons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="../global_assets/icons/favicon-16x16.png" />

    <!-- stylesheets -->
    <link rel="stylesheet" href="../styles/project_page.css">
    <link rel="stylesheet" href="../styles/highlight/styles/base16/bright.min.css">
    <link rel="stylesheet" href="../styles/katex/katex.min.css">

    <!-- syntax highlighting-->
    <script src="../styles/highlight/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>

    <!-- latex support-->
    <script defer src="../styles/katex/katex.min.js"></script>

    <!-- font -->
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
</head>

<body>
    <script src="../styles/themes/prism.js"></script>
    <div id="left_pad"></div>
    <aside>
        <h1><a href="..">Fast Robots</a></h1>
        <h3><em>Lab Reports:</em></h3>
        <nav>
            <ul>
                <li>
    <a href="../intro">
        <img src="../intro/assets/snapshot.webp" alt="Introduction">
        <div>
            <p>Introduction</p>
            <em> 1.27.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_1">
        <img src="../lab_1/assets/snapshot.webp" alt="Lab 1 - Artemis">
        <div>
            <p>Lab 1 - Artemis</p>
            <em> 1.27.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_2">
        <img src="../lab_2/assets/snapshot.webp" alt="Lab 2 - Bluetooth Communication">
        <div>
            <p>Lab 2 - Bluetooth Communication</p>
            <em> 2.2.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_3">
        <img src="../lab_3/assets/snapshot.webp" alt="Lab 3 - Time Of Flight (ToF)">
        <div>
            <p>Lab 3 - Time Of Flight (ToF)</p>
            <em> 2.9.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_4">
        <img src="../lab_4/assets/snapshot.webp" alt="Lab 4 - IMU">
        <div>
            <p>Lab 4 - IMU</p>
            <em> 2.16.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_5">
        <img src="../lab_5/assets/snapshot.webp" alt="Lab 5 - Motors and Open Loop Control">
        <div>
            <p>Lab 5 - Motors and Open Loop Control</p>
            <em> 2.23.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_6">
        <img src="../lab_6/assets/snapshot.webp" alt="Lab 6 - PID Orientation Control">
        <div>
            <p>Lab 6 - PID Orientation Control</p>
            <em> 3.9.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_7">
        <img src="../lab_7/assets/snapshot.webp" alt="Lab 7 - Kalman Filter">
        <div>
            <p>Lab 7 - Kalman Filter</p>
            <em> 3.16.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_8">
        <img src="../lab_8/assets/snapshot.webp" alt="Lab 8 - Stunts!">
        <div>
            <p>Lab 8 - Stunts!</p>
            <em> 3.23.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_9">
        <img src="../lab_9/assets/snapshot.webp" alt="Lab 9 - Mapping">
        <div>
            <p>Lab 9 - Mapping</p>
            <em> 4.13.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_10">
        <img src="../lab_10/assets/snapshot.webp" alt="Lab 10 - Localization (Sim)">
        <div>
            <p>Lab 10 - Localization (Sim)</p>
            <em> 4.20.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_11">
        <img src="../lab_11/assets/snapshot.webp" alt="Lab 11 - Localization (Real)">
        <div>
            <p>Lab 11 - Localization (Real)</p>
            <em> 4.27.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_12">
        <img src="../lab_12/assets/snapshot.webp" alt="Lab 12 - Path Planning and Execution">
        <div>
            <p>Lab 12 - Path Planning and Execution</p>
            <em> 5.4.23</em>
        </div>
    </a>
</li>
            </ul>
        </nav>
    </aside>
    <article id="article">
        <h1>
            Lab 12 - Path Planning and Execution
        </h1>
        <em class="date">
            5.4.23
        </em>
        <br>
        <h2>Introduction</h2>
<p>In this lab I combined my work in all past labs to make my car intelligently follow a set of waypoints.</p>
<p>The waypoints are as follows:</p>
<pre><code>1. (-4, -3)    &lt;--start
2. (-2, -1)
3. (1, -1)
4. (2, -3)
5. (5, -3)
6. (5, -2)
7. (5, 3)
8. (0, 3)
9. (0, 0)      &lt;--end
</code></pre>
<p><img src="./assets/waypoints.webp" alt="The waypoints plotted"></p>
<h2>Strategy</h2>
<p>Note that all waypoints are reachable using a straight line path from the previous waypoint. Because my localization results are so promising, I chose to ignore obstacle avoidance and trust that I can accurately follow the straight line paths. The resulting routine is:</p>
<ol>
<li>Localize</li>
<li>If localized point = waypoint, set next point as target waypoint.</li>
<li>Calculate angle and distance to target waypoint</li>
<li>Rotate to target angle</li>
<li>Move forward for time proportional to distance</li>
<li>Go to 1</li>
</ol>
<p>By running through this process enough times, the robot will eventually navigate the entire path.</p>
<h2>Implementation</h2>
<h4>Artemis Side</h4>
<p>For my previous labs, I used Python as a commander for most of the robots actions. This works fine when doing isolated tasks (ie localizing one time), but can lead to accumulated errors when the tasks are chained together. A large part of the error comes from BLE communication delay, which is non-deterministic.</p>
<p>Instead of trusting the unreliable timing from the laptop, I implemented a series of modes for the Artemis to address timing sensitive routines. These routines are seek angle, travel straight for time, and get localization readings. Pieced together, they are all thats needed for the algorithm outlined in strategy.</p>
<pre><code class="language-cpp">if(current_mode == TAKE_READINGS){
    if(mode_changed){
        // Record the starting rotation
        reading_start_rot = sensor_readings.gyro.z; 
        // Init PID 
        pid_controllers.pid[ROTATION].reset(); 
        pid_controllers.pid[ROTATION_RATE].reset();
        pid_controllers.setpoints[ROTATION] = reading_start_rot;
        pid_controllers.setpoints[ROTATION_RATE] = current_target;
        // Take readings
        data_buffers.enabled[POSE] = true;
        data_buffers.enabled[TOF] = true;
    }

    // Do a 360 to take readings
    if(sensor_readings.gyro.z - reading_start_rot &lt; 360.0){ 
    float out = pid_controllers.pid[ROTATION_RATE].output;
    if(out &gt;= -0.1){
        out = -0.1;          
    }
    set_wheel_output(out, -out);
    }else{
    data_buffers.enabled[POSE] = false;
    data_buffers.enabled[TOF] = false;
    current_mode =  SEEK_ANGLE;
    current_target = reading_start_rot;
    }
}
</code></pre>
<pre><code class="language-cpp">if(current_mode == SEEK_ANGLE){
    pid_controllers.setpoints[ROTATION] = current_target;
    float out = pid_controllers.pid[ROTATION].output;
    set_wheel_output(out, -out);
}
</code></pre>
<pre><code class="language-cpp">if(current_mode == MOVE_FORWARD){
    if(mode_changed){
    pid_controllers.setpoints[ROTATION] = sensor_readings.gyro.z;
    mode_start = millis();
    }
    float out = pid_controllers.pid[ROTATION].output;
    if(millis() - mode_start &lt; 100){
    set_wheel_output(0.5 + out, 0.5 - out);
    }
    else if(millis() - mode_start &lt; current_target){
    set_wheel_output(0.2 + out, 0.2 - out);
    }else{
    set_wheel_output(0, 0, true);
    }
}
</code></pre>
<h3>Python Side</h3>
<p>The straight line strategy I adopted requires precise localization to be effective. To get better readings, I doubled the resolution of the Bayes filter in all dimensions.</p>
<pre><code class="language-yaml"># Discrete cell sizes
# It is recommended that you do not change these values, unless you truly know what you are doing
cell_size_x: 0.1524
cell_size_y: 0.1524 
cell_size_a: 5

# Number of cells in each dimensions(x,y,a)
# Calculated based on the range divided by the cell size in each dimension
# Ex: max_cells_x = (max_x-min_x)/cell_size_x
# Must be integers
max_cells_x: 24  # Total number of grid cells in the x direction
max_cells_y: 18   # Total number of grid cells in the y direction
max_cells_a: 72  # Total number of grid cells in the a direction
</code></pre>
<p>Increasing the number of views dramatically increased the precaching time, taking it from 10 seconds to around two minutes. Luckily, this computation is only variable based on the map and the sensor arrangement, neither of which will change. I edited the base localization code to save the output to a file, then loaded the data from the file on future runs.</p>
<h2>Results</h2>
<p>I was unfortunately unable to finish this lab. The robot was able to successfully navigate two waypoints, then the motor drivers would overheat and cause the movement to become erratic. I hypothesize this had something to do with the rapid direction changes from the PID loop for angular velocity control. My laptop also decided to kick the bucket while debugging this issue, so thats all she wrote folks!</p>
<p>Thanks for a great semester to everyone involved. Live laugh fast robots.</p>

    </article>
    <div id="right_pad"></div>
</body>

</html>
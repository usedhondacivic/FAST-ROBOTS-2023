<!DOCTYPE html>
<html lang="en">

<head>
    <title>Lab 2 - Bluetooth Communication | Michael Crum's Portfolio</title>

    <!-- seo -->
    <meta name="author" content="Michael Crum">
    <meta name="description" content="Page for lab two">
    <meta name="keywords" content="portfolio,developer,robotics,personal">

    <!-- display -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- icon -->
    <link rel="icon" type="image/png" sizes="32x32" href="../global_assets/icons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="../global_assets/icons/favicon-16x16.png" />

    <!-- stylesheets -->
    <link rel="stylesheet" href="../styles/project_page.css">
    <link rel="stylesheet" href="../styles/highlight/styles/base16/bright.min.css">
    <link rel="stylesheet" href="../styles/katex/katex.min.css">

    <!-- syntax highlighting-->
    <script src="../styles/highlight/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>

    <!-- latex support-->
    <script defer src="../styles/katex/katex.min.js"></script>

    <!-- font -->
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
</head>

<body>
    <script src="../styles/themes/prism.js"></script>
    <div id="left_pad"></div>
    <aside>
        <h1><a href="..">Fast Robots</a></h1>
        <h3><em>Lab Reports:</em></h3>
        <nav>
            <ul>
                <li>
    <a href="../intro">
        <img src="../intro/assets/snapshot.webp" alt="Introduction">
        <div>
            <p>Introduction</p>
            <em> 1.27.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_1">
        <img src="../lab_1/assets/snapshot.webp" alt="Lab 1 - Artemis">
        <div>
            <p>Lab 1 - Artemis</p>
            <em> 1.27.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_2">
        <img src="../lab_2/assets/snapshot.webp" alt="Lab 2 - Bluetooth Communication">
        <div>
            <p>Lab 2 - Bluetooth Communication</p>
            <em> 2.2.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_3">
        <img src="../lab_3/assets/snapshot.webp" alt="Lab 3 - Time Of Flight (ToF)">
        <div>
            <p>Lab 3 - Time Of Flight (ToF)</p>
            <em> 2.9.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_4">
        <img src="../lab_4/assets/snapshot.webp" alt="Lab 4 - IMU">
        <div>
            <p>Lab 4 - IMU</p>
            <em> 2.16.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_5">
        <img src="../lab_5/assets/snapshot.webp" alt="Lab 5 - Motors and Open Loop Control">
        <div>
            <p>Lab 5 - Motors and Open Loop Control</p>
            <em> 2.23.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_6">
        <img src="../lab_6/assets/snapshot.webp" alt="Lab 6 - PID Orientation Control">
        <div>
            <p>Lab 6 - PID Orientation Control</p>
            <em> 3.9.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_7">
        <img src="../lab_7/assets/snapshot.webp" alt="Lab 7 - Kalman Filter">
        <div>
            <p>Lab 7 - Kalman Filter</p>
            <em> 3.16.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_8">
        <img src="../lab_8/assets/snapshot.webp" alt="Lab 8 - Stunts!">
        <div>
            <p>Lab 8 - Stunts!</p>
            <em> 3.23.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_9">
        <img src="../lab_9/assets/snapshot.webp" alt="Lab 9 - Mapping">
        <div>
            <p>Lab 9 - Mapping</p>
            <em> 4.13.23</em>
        </div>
    </a>
</li>
<li>
    <a href="../lab_10">
        <img src="../lab_10/assets/snapshot.webp" alt="Lab 10 - Localization (Sim)">
        <div>
            <p>Lab 10 - Localization (Sim)</p>
            <em> 4.20.23</em>
        </div>
    </a>
</li>
            </ul>
        </nav>
    </aside>
    <article id="article">
        <h1>
            Lab 2 - Bluetooth Communication
        </h1>
        <em class="date">
            2.2.23
        </em>
        <br>
        <h2 id="introduction">Introduction</h2>
<p>In this lab I established communication between my laptop and Artemis board using BLE.</p>
<h2 id="prelab">Prelab</h2>
<p>Before I could write any code, I needed to install the necessary tools.</p>
<p>I first went through this process on Windows 11, which didn't work. Changes to the Windows Bluetooth drivers have been causing issues class-wide, and I decided to cut my losses and switch to Linux.</p>
<p>I followed <a href="https://www.tomshardware.com/how-to/dual-boot-linux-and-windows-11">this guide</a> to install an Ubuntu partition on my laptop. I have previously had experience with Ubuntu through WSL, so the transition was fairly painless.</p>
<p>On my new Ubuntu installation I installed python and pip through the command line, and established a virtual environment. This allowed me to isolate this lab from any future python work that might break its dependencies. After installing the necessary dependencies, I could open Jupyter Notebook and begin working on demo.ipynb.</p>
<p>On the Arduino side, I burned the provided code onto the Artemis. This provided me with the following message:</p>
<p><code>Advertising BLE with MAC: c0:83:c:66:2f:3c</code></p>
<p>This MAC address is (meant to be) a unique identifier of my Artemis, allowing me to search for it among all other Bluetooth enabled devices.</p>
<p>My final before the lab was reading the codebase. On the Arduino side, the ArduinoBLE library is used to set up the Artemis as a BLE peripheral. The peripheral advertises one service (called testService) that offers three characteristics: <code>rx_characteristic_string, tx_characteristic_float, tx_characteristic_string</code>. These characteristics can be written too and read by the peripheral and any connected client, but we use them as their name suggests: transmission on tx and receiving on rx. </p>
<p>The Python side uses the Bleak package to establish a BLE central device. These act as the clients of the BLE world, and is aware of the characteristics of the Artemis.</p>
<h2 id="labtasks">Lab Tasks</h2>
<h3 id="configurations">Configurations</h3>
<p>Each service and characteristic the Artemis advertises also needs a unique identifier for the laptop to query. To ensure I was the only one talking to my device, I generated a new UUID for each. The following code is from ble_arduino.ino:</p>
<pre><code class="c language-c">#define BLE_UUID_TEST_SERVICE "f74736e0-f5ac-4541-959d-e6c1f1b3f55c"
#define BLE_UUID_RX_STRING "58482b00-4146-4122-be67-2d89016731a8"
#define BLE_UUID_TX_FLOAT "51eed2ce-3329-4232-b8d5-8f022aaa2d1a"
#define BLE_UUID_TX_STRING "aa71399e-0f1d-411d-ac23-7ace2936fd5e"
</code></pre>
<p>These UUID's match the ones stored in the python side's connection.yaml:</p>
<pre><code class="js language-js">artemis_address: 'c0:83:0c:66:2f:3c'

ble_service: 'f74736e0-f5ac-4541-959d-e6c1f1b3f55c'

characteristics:
  TX_CMD_STRING: '58482b00-4146-4122-be67-2d89016731a8'

  RX_FLOAT: '51eed2ce-3329-4232-b8d5-8f022aaa2d1a'
  RX_STRING: 'aa71399e-0f1d-411d-ac23-7ace2936fd5e'
</code></pre>
<p>Because I am running Linux, I also had to alter line 53 in base_ble.py, as outlined in the lab instructions.</p>
<h3 id="runningdemoipynb">Running demo.ipynb</h3>
<p>We were provided with a demo file to test our BLE connection. After switching to Ubuntu, I was able to run the full file with little difficulty, resulting in the following output:</p>
<p><img src="./assets/demo_start_py.webp" alt="The output from the Jupyter Notebook"></p>
<p><img src="./assets/demo_start_arduino.webp" alt="And the accompanying arduino shell output"></p>
<h3 id="sendinganechocommand">Sending an Echo Command</h3>
<p>An Echo command returns the message that was sent to it. In this case, I augmented the message to show that the robot was responding. This required defining a new command, which must be coordinated between the Arduino and Python code.</p>
<p>The Arduino code is as follows:</p>
<pre><code class="cpp language-cpp">case ECHO:

    char char_arr[MAX_MSG_SIZE];

    // Extract the next value from the command string as a character array
    success = robot_cmd.get_next_value(char_arr);
    if (!success)
        return;

    tx_estring_value.clear();
    tx_estring_value.append("Robot says -&gt; ");
    tx_estring_value.append(char_arr);
    tx_estring_value.append(" :)");
    tx_characteristic_string.writeValue(tx_estring_value.c_str());             

    break;
</code></pre>
<p>The final output was:</p>
<p><img src="./assets/echo.webp" alt="The output from the Echo command"></p>
<h3 id="creatingagettimecommand">Creating a Get Time Command</h3>
<p>The get time command was similar to the echo command, but also including a float.</p>
<p>The Arduino code:</p>
<pre><code class="cpp language-cpp">case GET_TIME_MILLIS:
    tx_estring_value.clear();
    tx_estring_value.append("T:");
    tx_estring_value.append((float)millis());
    tx_characteristic_string.writeValue(tx_estring_value.c_str());
    break;
</code></pre>
<p>The Python code and output:</p>
<p><img src="./assets/get_time_millis.webp" alt="The python code / output for get time"></p>
<h3 id="makinganotificationhandler">Making a Notification Handler</h3>
<p>We often don't know when a message will be posted, but want to be alerted when it does. Bleak call these events notifications, and provides a method to register a handler function. Below is the Python code for implementing one, which extracts the timestamp from a message.</p>
<p><img src="./assets/handler_test.webp" alt="The python notifier"></p>
<h3 id="writingthegettemperaturecommand">Writing the Get Temperature Command</h3>
<p>The Artemis includes a temperature sensor and methods to access its data, so getting the temperature was similar to getting the time. In order to time the successive reads I used a delay. Below is the relevant code:</p>
<pre><code class="cpp language-cpp">case GET_TEMP_5S:
    for(int i = 0; i &lt; 5; i++){
        unsigned long start = millis();
        tx_estring_value.clear();
        tx_estring_value.append("T:");
        tx_estring_value.append((float)start);
        tx_estring_value.append("|C:");
        tx_estring_value.append((float)getTempDegF());
        if(i!=4){
            tx_estring_value.append("|");                  
        }

        tx_characteristic_string.writeValue(tx_estring_value.c_str());
        delay(start + 1000 - millis());                
    }
    break;
</code></pre>
<p>And Python output</p>
<p><img src="./assets/temp_5s_test.webp" alt="The Python output of the Get Temperature Command"></p>
<p>I also wrote a command that attempts to sample and relay data at 20Hz, which is shown below:</p>
<p>Arduino code:</p>
<pre><code class="cpp language-cpp">case GET_TEMP_5S_RAPID:
    for(int i = 0; i &lt; 20*5; i++){
        unsigned long start = millis();
        tx_estring_value.clear();
        tx_estring_value.append("T:");
        tx_estring_value.append((float)start);
        tx_estring_value.append("|C:");
        tx_estring_value.append((float)getTempDegF());
        if(i!=4){
            tx_estring_value.append("|");                  
        }

        tx_characteristic_string.writeValue(tx_estring_value.c_str());
        delay(start + 50 - millis()); // Around 20 times per sec                    
    }
    break;
</code></pre>
<p>Python code / output:</p>
<p><img src="./assets/temp_rapid.webp" alt="The python output for rapid temperature sensing"></p>
<p>The output is clipped, but continues for 100 readings over 5 seconds.</p>
<h3 id="limitations">Limitations</h3>
<p>Dealing with the BLE overhead as well as constructing string messages takes a huge number of processor cycles. In some high speed applications this is unacceptable, and real time data relaying is not possible. In these cases, we need to store data and relay it at some other time.</p>
<p>With 384 kb of RAM, the Artemis can store 192,000 16 bit words. Assuming we are sampling 10 data points at 150Hz, this gives 1500 words per second. The Artemis would run out of storage in 128 seconds.</p>
<p>Although this is inversely proportional to the amount of data points we store, this should be enough to execute tricks and relay data afterwards. </p>
<h2 id="conclusion">Conclusion</h2>
<p>Although my first attempts at using Windows 11 were rocky, the rest of the lab went smoothly in Linux. I am confident that I will be able to use Bluetooth to interface with and debug my robot over the following labs.</p>
    </article>
    <div id="right_pad"></div>
</body>

</html>
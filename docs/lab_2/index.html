<!DOCTYPE html>
<html lang="en">

<head>
    <title>Lab 2 - Bluetooth Communication</title>

    <!-- seo -->
    <meta name="author" content="Michael Crum">
    <meta name="description" content="Michael Crum's portfolio and blog website.">
    <meta name="keywords" content="portfolio,developer,robotics,personal">

    <!-- display -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- icon -->
    <link rel="icon" type="image/png" sizes="32x32" href="../global_assets/icons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="../global_assets/icons/favicon-16x16.png" />

    <!-- stylesheets -->
    <link rel="stylesheet" href="../styles/project_page.css">

    <!-- font -->
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
</head>

<body>
    <div id="left_pad"></div>
    <aside>
        <h1><a href="..">ECE 4160:<br>Fast Robots</a></h1>
        <h3><em>Labs:</em></h3>
        <nav>
            <ul>
                <a href="../intro">
    <li>
        <img src="../intro/assets/snapshot.png">
        <div>
            <p>Introduction</p>
            <em> 1.27.23</em>
        </div>
    </li>
</a>
<br>
<a href="../lab_1">
    <li>
        <img src="../lab_1/assets/snapshot.png">
        <div>
            <p>Lab 1 - Artemis</p>
            <em> 1.27.23</em>
        </div>
    </li>
</a>
<br>
<a href="../lab_2">
    <li>
        <img src="../lab_2/assets/snapshot.png">
        <div>
            <p>Lab 2 - Bluetooth Communication</p>
            <em> 2.2.23</em>
        </div>
    </li>
</a>
<br>
<a href="../lab_3">
    <li>
        <img src="../lab_3/assets/snapshot.png">
        <div>
            <p>Lab 3 - TOF and IMU</p>
            <em> 2.9.23</em>
        </div>
    </li>
</a>
<br>
<a href="../lab_4">
    <li>
        <img src="../lab_4/assets/snapshot.png">
        <div>
            <p>Lab 4 - Characterize your Car</p>
            <em> 2.16.23</em>
        </div>
    </li>
</a>
<br>
            </ul>
        </nav>
    </aside>
    <article id="article">
        <h1>
            Lab 2 - Bluetooth Communication
        </h1>
        <em class="date">
            2.2.23
        </em>
        <h2 id="introduction">Introduction</h2>
<p>In this lab I established communication between my laptop and Artemis board using BLE.</p>
<h2 id="prelab">Prelab</h2>
<p>Before I could write any code, I needed to install the necessary tools.</p>
<p>I first went through this process on Windows 11, which didn't work. Changes to the Windows Bluetooth drivers have been causing issues class-wide, and I decided to cut my losses and switch to Linux.</p>
<p>I followed <a href="https://www.tomshardware.com/how-to/dual-boot-linux-and-windows-11">this guide</a> to install an Ubuntu partition on my laptop. I have previously had experience with Ubuntu through WSL, so the transition was fairly painless.</p>
<p>On my new Ubuntu installation I installed python and pip through the command line, and established a virtual environment. This allowed me to isolate this lab from any future python work that might break its dependencies. After installing the necessary dependencies, I could open Jupyter Notebook and begin working on demo.ipynb.</p>
<p>On the Arduino side, I burned the provided code onto the Artemis. This provided me with the following message:</p>
<p><code>Advertising BLE with MAC: c0:83:c:66:2f:3c</code></p>
<p>This MAC address is (meant to be) a unique identifier of my Artemis, allowing me to search for it among all other Bluetooth enabled devices.</p>
<p>My final before the lab was reading the codebase. On the Arduino side, the ArduinoBLE library is used to set up the Artemis as a BLE peripheral. The peripheral advertises one service (called testService) that offers three characteristics: <code>rx_characteristic_string, tx_characteristic_float, tx_characteristic_string</code>. These characteristics can be written too and read by the peripheral and any connected client, but we use them as their name suggests: transmission on tx and receiving on rx. </p>
<p>The Python side uses the Bleak package to establish a BLE central device. These act as the clients of the BLE world, and is aware of the characteristics of the Artemis.</p>
<h2 id="labtasks">Lab Tasks</h2>
<h3 id="configurations">Configurations</h3>
<p>Each service and characteristic the Artemis advertises also needs a unique identifier for the laptop to query. To ensure I was the only one talking to my device, I generated a new UUID for each. The following code is from ble_arduino.ino:</p>
<pre><code>#define BLE_UUID_TEST_SERVICE "f74736e0-f5ac-4541-959d-e6c1f1b3f55c"
#define BLE_UUID_RX_STRING "58482b00-4146-4122-be67-2d89016731a8"
#define BLE_UUID_TX_FLOAT "51eed2ce-3329-4232-b8d5-8f022aaa2d1a"
#define BLE_UUID_TX_STRING "aa71399e-0f1d-411d-ac23-7ace2936fd5e"
</code></pre>
<p>These UUID's match the ones stored in the python side's connection.yaml:</p>
<pre><code>artemis_address: 'c0:83:0c:66:2f:3c'

ble_service: 'f74736e0-f5ac-4541-959d-e6c1f1b3f55c'

characteristics:
  TX_CMD_STRING: '58482b00-4146-4122-be67-2d89016731a8'

  RX_FLOAT: '51eed2ce-3329-4232-b8d5-8f022aaa2d1a'
  RX_STRING: 'aa71399e-0f1d-411d-ac23-7ace2936fd5e'
</code></pre>
<p>Because I am running Linux, I also had to alter line 53 in base_ble.py, as outlined in the lab instructions.</p>
<h3 id="runningdemoipynb">Running demo.ipynb</h3>
<p>We were provided with a demo file to test our BLE connection. After switching to Ubuntu, I was able to run the full file with little difficulty, resulting in the following output:</p>
<p><img src="./assets/demo_start_py.png" alt="The output from the Jupyter Notebook" />
<img src="./assets/demo_start_arduino.png" alt="And the accompanying arduino shell output" /></p>
<h3 id="sendinganechocommand">Sending an Echo Command</h3>
<p>An Echo command returns the message that was sent to it. In this case, I augmented the message to show that the robot was responding. This required defining a new command, which must be coordinated between the Arduino and Python code.</p>
<p>The arduino code is as follows:</p>
<pre><code>case ECHO:

            char char_arr[MAX_MSG_SIZE];

            // Extract the next value from the command string as a character array
            success = robot_cmd.get_next_value(char_arr);
            if (!success)
                return;

            /*
             * Your code goes here.
             */
            tx_estring_value.clear();
            tx_estring_value.append("Robot says -&gt; ");
            tx_estring_value.append(char_arr);
            tx_estring_value.append(" :)");
            tx_characteristic_string.writeValue(tx_estring_value.c_str());             

            break;
</code></pre>
<p>The final output was:
<img src="./assets/echo.png" alt="The output from the Echo command" /></p>
<h3 id="creatingagettimecommand">Creating a Get Time Command</h3>
<h3 id="makinganotificationhandler">Making a Notification Handler</h3>
<h3 id="writingthegettemperaturecommand">Writing the Get Temperature Command</h3>
<h3 id="limitations">Limitations</h3>
<h2 id="conclusion">Conclusion</h2>
    </article>
    <div id="right_pad"></div>
</body>

</html>